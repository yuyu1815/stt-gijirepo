# 文字起こし機能の詳細

このドキュメントでは、音声文字起こし・議事録自動生成ツールに実装されている文字起こし機能について詳細に説明します。

## 1. 概要

文字起こし機能は、音声ファイルや動画ファイルから自動的にテキストを生成し、タイムスタンプや話者情報を付与する機能です。Gemini APIを活用した高精度な文字起こしを実現し、長時間メディアの処理や並列処理にも対応しています。

## 2. 文字起こしワークフロー

### 2.1 全体的なフロー

1. **メディアファイル処理**:
   - メディアファイルを入力として受け取る
   - メディアタイプ（音声/動画）を判定
   - ファイルの長さを取得
   - 動画の場合は品質を判定

2. **前処理**:
   - 暗い動画の場合は音声を抽出
   - 長時間メディア（40分以上）の場合はチャンクに分割

3. **文字起こし**:
   - チャンクがある場合は各チャンクを個別に文字起こし
   - チャンクがない場合は単一ファイルとして文字起こし
   - チャンクの文字起こし結果を結合

4. **ハルシネーションチェック**:
   - 文字起こし結果のハルシネーション（幻覚）をチェック
   - 重大度に応じて結果を分類

5. **議事録生成**:
   - 文字起こし結果から議事録の基本情報を設定
   - Gemini APIを使用して議事録内容を生成
   - 画像がある場合は追加
   - 議事録を保存

### 2.2 メディアファイル処理

- **対応フォーマット**:
  - 音声ファイル: mp3, wav, aac, m4a, flac
  - 動画ファイル: mp4, avi, mov, mkv, webm
- **動画品質判定**: 暗い動画を検出し、音声のみを抽出
- **ファイル長さ取得**: FFprobeを使用してメディアの長さを取得

### 2.3 メディアファイル分割

- **長時間メディアの判定**: 設定された閾値（デフォルト40分）以上のメディアを長時間と判定
- **チャンク分割**: 長時間メディアを指定された長さ（デフォルト20分）のチャンクに分割
- **チャンク情報管理**: 各チャンクの開始時間、終了時間、ファイルパスを管理

## 3. 文字起こし機能

### 3.1 単一ファイル文字起こし

- **Gemini APIの活用**: 高精度な文字起こしのためにGemini APIを使用
- **プロンプト設計**: 文字起こしの精度を高めるための専用プロンプトを使用
- **再試行メカニズム**: API呼び出しが失敗した場合の指数バックオフによる再試行
- **レート制限対応**: API呼び出しのレート制限に対応するための待機メカニズム

### 3.2 チャンク文字起こし

- **並列処理**: 複数のチャンクを並列に処理することによる処理時間の短縮
- **タイムスタンプ調整**: チャンクごとの相対的なタイムスタンプを絶対的なタイムスタンプに変換
- **結果の収集**: 各チャンクの文字起こし結果を収集し、一つの結果にまとめる

### 3.3 文字起こし結果のパース

- **セグメント抽出**: 文字起こしテキストからタイムスタンプ付きのセグメントを抽出
- **話者識別**: 可能な場合は話者を識別し、各セグメントに話者情報を付与
- **スクリーンショット指示の検出**: 文字起こしテキスト内のスクリーンショット指示を検出し処理

### 3.4 文字起こし結果の結合

- **セグメントの収集**: 全チャンクからセグメントを収集
- **タイムスタンプによるソート**: セグメントをタイムスタンプでソートして時系列順に並べる
- **結合結果の保存**: 結合された文字起こし結果をJSON形式で保存

## 4. ハルシネーションチェック機能

### 4.1 ハルシネーション検出

- **重大度レベル**: NONE, LOW, MEDIUM, HIGHの4段階で評価
- **検出方法**: Gemini APIを使用して文字起こし結果の信頼性を評価
- **長時間メディア対応**: チャンクごとにハルシネーションチェックを実行

### 4.2 ハルシネーション修正

- **修正テキストの提供**: 検出されたハルシネーションに対して修正テキストを提供
- **理由の説明**: ハルシネーションと判断した理由を説明
- **結果レポート**: 検出率、重大度別の集計、詳細結果を含むレポートの生成

## 5. 議事録生成機能

### 5.1 議事録の基本情報設定

- **タイトル生成**: ファイル名や内容から適切なタイトルを生成
- **日付抽出**: ファイル名や内容から日付を抽出
- **メタデータ設定**: 講師名、科目名などのメタデータを設定

### 5.2 議事録内容の生成

- **Gemini APIの活用**: 文字起こし結果から構造化された議事録を生成
- **セクション分け**: 要約、議事内容、重要ポイント、タスク、用語集などのセクションに分割
- **画像の統合**: 動画分析から抽出された画像を議事録に統合

### 5.3 議事録の保存

- **Markdown形式**: 議事録をMarkdown形式で保存
- **構造化**: 見出し、段落、箇条書きリストなどの構造化された形式で保存
- **画像の埋め込み**: 抽出された画像をタイムスタンプと説明付きで埋め込み

## 6. Notion連携機能

### 6.1 Notionページの作成

- **ページプロパティ設定**: タイトル、日付、科目名、講師名などのプロパティを設定
- **ブロック作成**: 見出し、段落、箇条書きリスト、区切り線などのブロックを作成
- **長いテキストの分割**: Notionの制限に対応するための長いテキストの自動分割

### 6.2 画像のアップロード

- **画像の埋め込み**: 抽出された画像をNotionページに埋め込み
- **キャプション付与**: 画像にタイムスタンプと説明を付与

## 7. 設定オプション

### 7.1 文字起こし設定

- `transcription.model`: 文字起こしモデル
- `transcription.language`: 文字起こし言語
- `transcription.task`: 文字起こしタスク
- `transcription.word_timestamps`: 単語レベルのタイムスタンプ有効化

### 7.2 メディア処理設定

- `media_processor.chunk_duration`: チャンク分割の長さ（秒）

### 7.3 ハルシネーション設定

- `hallucination.enabled`: ハルシネーションチェック有効化
- `hallucination.threshold`: ハルシネーション検出閾値

### 7.4 並列処理設定

- `parallel.thread_workers`: スレッドワーカー数
- `parallel.process_workers`: プロセスワーカー数

## 8. ドメインモデル

### 8.1 文字起こしドメインモデル

- **TranscriptionStatus**: 文字起こしの状態（PENDING, IN_PROGRESS, COMPLETED, FAILED）
- **HallucinationSeverity**: ハルシネーションの重大度（NONE, LOW, MEDIUM, HIGH）
- **Speaker**: 話者情報（ID, 名前）
- **TranscriptionSegment**: 文字起こしセグメント（テキスト, 開始時間, 終了時間, 話者, 信頼度）
- **HallucinationResult**: ハルシネーションチェック結果（セグメント, 重大度, 理由, 修正テキスト）
- **TranscriptionResult**: 文字起こし結果（ソースファイル, セグメント, 状態, ハルシネーション結果, メタデータ）

### 8.2 議事録ドメインモデル

- **MinutesFormat**: 議事録フォーマット（MARKDOWN, HTML, PLAIN_TEXT）
- **MinutesSection**: 議事録セクション（HEADER, SUMMARY, CONTENT, IMPORTANT_POINTS, TASKS, GLOSSARY, IMAGES）
- **MinutesHeading**: 議事録見出し（テキスト, レベル, タイムスタンプ）
- **MinutesTask**: 議事録タスク（説明, 期限, 担当者）
- **GlossaryItem**: 用語集項目（用語, 定義）
- **MinutesContent**: 議事録内容（見出し, 段落, タスク, 用語集, 画像）
- **Minutes**: 議事録（タイトル, 日付, 内容, ソース文字起こし, フォーマット, 講師, 科目, 出席者, メタデータ, 出力パス）